# コラム5（差の差の分析法） {#causation5}

本節では、疑似実験と呼ばれる構造を捉えた、差の差の分析法という手法を紹介する。ランダム化ができない中でもデータの構造をうまく使い、ある仮定のもとで因果効果に迫るのが、因果推論と呼ばれる方法である。特に、完全なランダム化ではないが観測個体にとって処置の選択権がなかったような状況を疑似実験と呼ぶ。そして、この構造を活用した分析手法が本節で紹介する差の差の分析法（Difference-in-Differences: DID）である。

DIDは企業や政府の行動による構造変化や、自然などによる外生ショック（感染症、異常気象、災害）を利用した分析手法である。自身の研究課題に関連する構造変化や外生ショックを見つけることができれば、フィールド実験よりも実現可能性が高い方法として、マーケティング領域でも多くの研究で採用されている。

DIDを行うためには、研究上着目する処置がある個人やグループには割り当てられているがそれ以外には割り当てられていない状況を特定し、その状況に対応する観察対象者の処置前と処置後のデータを有する事が必要となる。つまり、複数の観察個体に対する複数時点のデータを得てパネルデータセットを構築する必要がある。

DIDを理解するためには、処置に与える変化、処置群と統制（コントロール）群の特定、処置前・処置後のデータという、構造を踏まえる必要がある。ここで、DIDの必要性を理解するために、（1）前後比較と（2）群間比較という比較方法について説明する。まず前後比較とは、処置を受けた個体群を集め、このグループの処置前と処置後の結果を比較する方法である。例えば、企業業績の前年比較は典型的な前後比較である。しかしながら、前後比較では処置とは関係のないマクロトレンドなど影響をコントロールできないという限界がある。例えば、企業の取り組みや変化にあたる処置の有無に関わらず、景気や気象条件などの環境変化が企業業績が影響を与えることも考えられる。そのような場合、前後比較では自社にとって有利な環境の変化と処置による効果を見誤ってしまう。

一方で群間比較は、処置を受けた群と受けていない群間で着目する変数の値を比較する方法である。しかしながらこの方法では、\@ref(causation2) で紹介したセレクションバイアスによる影響を見過ごしてしまう。ランダム化を介した処置の割り当てができない場合、処置の有無と（潜在）成果変数とが独立ではなくなってしまい、因果効果を推定できない。

これらの問題に対応するためにDIDでは、以下の図で示すように「差の差」に着目する。DIDにおいては（A）処置群の事前データ、（A'）処置群の事後データ、（B）統制群の事前データ、（B'）統制群の事後データ、の４種類のデータを用いる。このデータのうち、それぞれの群における事前事後の差（$A-A'$ と $B-B'$）を求めたあとに、これらの差の差（$(A-A')-(B-B')$）を捉えることで平均処置効果を求める。

![DIDの概要](column/DID.png)

処置郡内の前後比較（$A-A'$）には、処置による効果に加え、セレクションバイアスは含まれていないがマクロトレンドなどに代表される時系列変化による影響が含まれている。そして処置による効果と時系列変化の影響はどちらも観察できない。一方で統制群内の前後比較（$B-B'$）には処置による効果は含まれておらず、（他の要素を一定だとするならば）時系列変化による影響だけが含まれているはずである。そのため、差の差を捉えることで、前後比較（$A-A'$）に含まれている情報のうち時系列変化に関する影響だけ排除し、処置による効果を抽出しようという方法である。下図における点Cは「もし処置がなかった場合の処置群の成果」を示しており、観察できない情報である。$A-A'$から$B-B'$を引くことで、仮想的に $A-C$ を分析しようというのがDIDの直感的な説明である。
![DIDによる効果測定の直感](column/DID2.png)


分析においては、処置群であれば1を取るような処置群ダミー（$D^{treat}_{i}$）と、処置後の観測であれば1を取るような事後ダミー（$D^{post}_{t}$）を用いて、以下のような回帰モデルを採用する：

$$
Y_{it}=\alpha+\beta(D^{treat}_{i}\times D^{post}_{t})+\gamma D^{treat}_{i}+\delta D^{post}_{t}+u_{it}
$$
上記のモデルにおける係数$\beta$を確認、検定することで疑似実験の効果についての知見を得る。

なお、分析においては \@ref(causation4) で紹介した、以下の二方向の固定効果（$\mu_i$と$\lambda_t$）を含む回帰モデルで推定することも可能である。

$$
Y_{it}=\mu_i+\lambda_t+\beta(D^{treat}_{i}\times D^{post}_{t})+\gamma D^{treat}_{i}+\delta D^{post}_{t}+u_{it}
$$

このとき、処置群ダミー（$D^{treat}_{i}$）と事後ダミー（$D^{post}_{t}$）はそれぞれ、観測個体固定効果（$\mu_i$）と時間固定効果（$\lambda_t$）に吸収されてしまうため、結果的に以下のモデルでDID推定を行うことができる。
$$
Y_{it}=\mu_i+\lambda_t+\beta(D^{treat}_{i}\times D^{post}_{t})+u_{it}
$$
このように、回帰モデルを用いてDID推定を行う場合には、パネルデータ分析、特に固定効果モデルに対する知識も必要になる。

なお、DIDも他の手法と同様、平均処置効果を得るためにはいくつかの仮定を満たす必要がある。具体的には、SUTVAなど（\@ref(causation2) 参照）因果推論に関わる基本的な仮定に加え、並行トレンド（Parallel trend）の仮定を満たす場合、DIDによって（処置群における）平均処置効果（Average Treatment Effects on Treated）を分析することが可能であることが知られている。並行トレンドとは、処置がない場合、処置群と統制群の成果の平均のトレンド（時間変化）が等しいという仮定である。そのため、処置がない場合、横軸を時間、縦軸を成果変数（の平均値）とした際の両群の成果に関する曲線（直線）は並行になる（上図におけるA-CとB-B'の直線は並行になる）ことを意味する。

また、処置効果の異質性がないことも重要である。平均処置効果がグループや時間によって変化する場合、推定結果にバイアスがかかることが知られている。例えば、成果等による介入効果が時間によって変化する（長期的に効果が弱まるなどの）場合や、処置効果が特に処置群に強い影響を与えうる（影響を強く受けそうな群に処置が行われている）場合には異質な処置効果（Heterogenous treatment effects）として、問題になる。これに加えて、SUTVAでも議論したスピルオーバーがないこともDIDでは重要かつ満たすことが容易ではない仮定となる。自然災害や紛争など地理的要因に紐づいた構造変化を捉える場合、少なからず地理的な近接性に伴うスピルオーバー効果が生まれる可能性があるため、注意が必要となる。

上記の仮定を満たしているかについて、正当化のための理想的な方法はない。図示化や論理的説明（産業的知識）が用いて、上記の仮定が満たされていることを説得的に記述することが求められる。また、その説明の補助として統計的検定が併用されることも多い。


## Fisher et al. (2019) による配送能力と小売成果の研究
現代の小売業では、オフライン（実店舗）とオンライン（Eコマース、モバイル）を結合したオムニチャネルと呼ばれる小売環境を構築することが増えている。オムニチャネル環境においては、物流自動化などに代表される物流能力（速さと正確さ）の向上が重要な投資であることが論じられてきた（田頭, 2024）。物流システムへの投資は高いコストがかかる一方で、オンラインとオフライン両方の販売チャネルを有する企業の成果へ与える影響は明示的に示されていなかった。

Fisher et al. (2019) は企業による新たな物流倉庫（Distribution Center: DC）の設立に着目し、オムニチャネル小売文脈において、製品の配送スピードの向上が企業成果へ与える影響について分析を行った。この研究では、米国のオムニチャネルアパレル小売企業のEコマースおよび店舗データと地域の配送状況データを結合しデータセットを構築した。その企業は元々、米国東側にDCを設置しており、その東側のDCから米国全土からの注文と顧客への配送に対応していた。そのため、西部の顧客からのEC注文では、製品の配送完了に7営業日を要していた。

このような背景のもと、当該企業は2012年に米国西側に新しい「オンライン用」DCを設立した。そしてこの新DCは西側からの注文にのみ対応していた。この新DC設立を擬似実験として捉え、新DC（西側地域の）注文エリアに入る顧客と店舗を処置群、それ以外（東側地域の）顧客と店舗を統制群とした。なお、新DCの設立によってほとんどの西側地域のEコマース注文製品は配送完了に要する日数が短縮された。また、この企業はデータ観測の期間中に配送時間の短縮について広告や宣伝を行っていないため、情報伝達による影響はコントロールされている。

Fisher et al. (2019) ではDIDに基づくモデル化に加え、傾向スコア（Propensity Score）ウェイトを計算とそのコントロールを行っている。傾向スコアとは、処置に影響を与えうる先行要因に基づき、「処置の受けやすさの程度」についてスコア化したものである。このスコアを用いて、似た人を探し出し比較対象を特定化したり（傾向スコアマッチング）、回帰分析における重み付けとして活用することで処置の受けやすさについてコントロールする（傾向スコア回帰）ことが行われる（松浦, 2024）。傾向スコアについいての詳細は省略するが、Fisher et al. (2019) では完全にランダムではない擬似実験で生じうる問題として、処置群と統制群が事前に持っていた違いについて、傾向スコア回帰を応用することで対応することを試みている。

分析の結果、配送時間の短縮（新DCの設立）は、Eコマースにおける、週当たりの新規顧客数、取引数、バスケットサイズ（一回注文あたりの平均額）が上昇することを示した。これは、配送時間というEコマースサービス品質の向上が当該販売チャネルの成果につながることを示した結果だといえる。また分析結果では、配送時間の短縮が実店舗の週当たり取引数の増加につながることも示した。この結果は、Eコーマスへの投資が実店舗の成果向上にもつながる、販売チャネル間スピルオーバー効果を示唆している。

このような分析結果に対して Fisher et al. (2019) ではそのメカニズムに迫るような探索的データ分析を実施している。その結果、以下の三つの点を明らかにした。

1. 配送時間短縮による影響は、新DCからの累積出荷数が多いエリアほど強い。
  - これは、顧客の（早い配送に対する）経験学習効果がある可能性を示唆している。

2. 配送時間短縮による影響は、Eコマース店舗普及率や実店舗数といった当該小売ブランドの存在感が強いエリアほど強い。
  - この結果は、ブランド力による向上効果を示唆している。

3. Eコマース店舗の購買経験が少ない顧客は、配送時間の短縮に反応し、短期的にはそれが顕著なものとして観察されるが、長期的には、購買経験の高い顧客の反応が顕著になる。
  - 観察されたDID推定の結果について、短期的には学習効果がそれを牽引し、長期的にはブランド力による影響が起因していると解釈できる。
  
このように、因果推論を用いた係数の推定や検定自体は、その効果の背後にあるメカニズムを説明することには繋がらない場合もある。その場合には、メカニズムに迫るような追加的な調査や分析を行うことで、「なぜそのような結果に繋がるのか」というという問いについて検討する必要がある。


## 参考文献

Fisher, M. L., Gallino, S., & Xu, J. J. (2019). The Value of Rapid Delivery in Omnichannel Retailing. *Journal of Marketing Research*, 56(5), 732-748.

田頭拓己（2024）「オムニチャネル環境下での小売戦略」, 『一橋ビジネスレビュー』, 71巻, 4号, 18-31.
